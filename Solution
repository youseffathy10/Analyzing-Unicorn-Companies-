WITH top_3_comp AS 
(SELECT industry , COUNT(*)
FROM industries 
JOIN dates
ON industries.company_id = dates.company_id
JOIN funding
ON funding.company_id = industries.company_id
WHERE DATE_PART('year',date_joined)  BETWEEN 2019 AND 2021
GROUP BY industry
ORDER BY COUNT DESC
LIMIT 3)


SELECT top_3_comp.industry, DATE_PART('year',date_joined) AS year ,COUNT(*) num_unicorns ,ROUND(AVG(valuation)/1000000000::NUMERIC,2) average_valuation_billions
FROM industries 
JOIN dates
ON industries.company_id = dates.company_id
JOIN funding
ON funding.company_id = industries.company_id
JOIN top_3_comp
ON top_3_comp.industry = industries.industry
WHERE  DATE_PART('year',date_joined) BETWEEN 2019 AND 2021
GROUP BY 1,2
ORDER BY year DESC ,num_unicorns DESC 
